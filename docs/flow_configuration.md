# Quota Board Flow Configuration Guide

This document describes how to configure the `flow` execution pipeline for your integrations in Quota Board. The flow configuration allows you to define a sequence of steps to handle complex authentication and data extraction scenarios.

## Overview

The `flow` configuration replaces the legacy single-step extraction method with a robust, sequential pipeline of steps. It is designed to handle complex authentication flows (like OAuth or browser-based scraping) and multi-request data fetching.

A key feature of the Flow engine is its **controlled suspension**: if a step requires user interaction (such as entering an API key or authorizing an OAuth application), the execution will pause, surface an interactive request to the user via the UI, and resume once the required credentials are provided.

## Flow Common Properties

Each step in the `flow` array is an object that defines a specific action. All steps share the following core properties:

*   **`id`** *(string, required)*: A unique identifier for the step, used for logging and tracking execution.
*   **`use`** *(string, required)*: The type of tool or action to execute. (e.g., `http`, `extract`, `script`, `api_key`, `webview`).
*   **`args`** *(object, optional)*: A dictionary of arguments specific to the chosen tool. These arguments fully support dynamic variable interpolation (e.g., `{access_token}`).
*   **`outputs`** *(object, optional)*: A mapping that extracts specific keys from the step's result and saves them as variables for downstream steps. Example: `{"raw_token": "access_token"}` routes the output's `raw_token` field into a variable named `access_token`.
*   **`secrets`** *(object, optional)*: A mapping that explicitly defines which internal variables should be securely and permanently stored in the `SecretsController` for future executions. Example: `{"api_key": "my_secret_name"}`.

### Variable Interpolation & Scope

Arguments within `args` can dynamically embed data from previous steps using the `{variable_name}` syntax. The Flow engine resolves these variables using the following priority (highest to lowest):

1.  **Step Outputs**: Variables newly generated by the immediately preceding step.
2.  **Flow Context**: Global variables accumulated throughout the flow or injected from the source configuration.
3.  **Secrets Storage**: Persistent credentials securely saved in the database (e.g., API keys, OAuth tokens).

## Blocking Auth Tools (Èâ¥ÊùÉÁõ∏ÂÖ≥Â∑•ÂÖ∑)

These tools act as check-points. If the required credentials (like tokens or cookies) are not found in the `SecretsController`, the flow execution suspends, and an interactive prompt is surfaced in the Quota Board UI. Once the user provides the necessary input or authorization, the flow resumes.

### api_key
Use this step to prompt the user for a standard text string, such as a Bearer token, password, or API Key.

**`secrets` Mapping:**
*   `api_key` *(string, default: "api_key")*: The internal name used to store this value securely.

**`args` Properties:**
*   `label` *(string, default: "API Key")*: The title of the input field presented to the user.
*   `description` *(string, default: "Please enter the API Key")*: Explanatory text under the input field.
*   `message` *(string, default: "Missing API Key for [Source Name]")*: The primary instruction text above the input field.

**Outputs:**
By default, the entered value is output dynamically as `api_key`. You can route it to a new flow variable using the `outputs` property (e.g., `outputs: {"api_key": "access_token"}`).

### oauth
Triggers a standard standard OAuth 2.0 authorization code flow. It redirects the user to the provider's authorization page.

**`args` Properties:**
*   `client_id` *(string, optional)*: If omitted, the UI will prompt the user to input their Client ID.
*   `client_secret` *(string, optional)*: If omitted, the UI will prompt the user to input their Client Secret.
*   `doc_url` *(string, optional)*: A link to external documentation guiding the user on where to generate the OAuth credentials.

**Outputs:**
Upon successful authorization, the retrieved token is output as `access_token` and automatically stored securely.

### curl
A tool for advanced integrations that require "reverse-engineering" browser requests. It prompts the user to paste a raw cURL command copied from their browser's Developer Tools, then parses it to extract required headers or cookies.

> [!WARNING]
> This method may violate the Terms of Service of third-party platforms.

**`secrets` Mapping:**
*   `curl_command` *(string, default: "curl_command")*: The internal name to store the raw command.

**`args` Properties:**
*   `label` *(string, default: "cURL Request")*: The title of the input field.
*   `description` *(string, default: "Paste your cURL command here")*: Explanatory text under the input field.
*   `message` *(string, default: "Provide cURL request for [Source Name]")*: The primary instruction text.
*   `warning_message` *(string, optional)*: **Crucial for compliance.** Displays a prominent yellow warning banner to the user (e.g., "Using this integration may violate ToS.").

**Outputs:**
The tool parses the `--header` or `-H` flags from the cURL command.
*   To extract a specific header, define the mapping in `outputs` (e.g., `outputs: {"authorization": "auth_token"}`).
*   To extract all headers as a dictionary, use `outputs: {"headers": "all_headers"}`.

### webview
Executes a headless or background browser session to programmatically scrape data or intercept API network requests. This is useful for platforms that heavily rely on complex browser-side rendering or cookies.

**`secrets` Mapping:**
*   `webview_data` *(string, default: "webview_data")*: The internal name used to store the extracted data.

**`args` Properties:**
*   `url` *(string, required)*: The URL to load in the background browser.
*   `script` *(string, optional)*: A JavaScript code snippet injected into the page to extract DOM content, `localStorage`, or cookies.
*   `intercept_api` *(string, optional)*: A URL substring or Regex pattern. The webview will capture the JSON response of matching network requests.

**Outputs:**
The tool outputs mapping values depending on the `script` return value or the intercepted API payload body.

## Data Processing Tools

These tools handle standard data acquisition and manipulation, generally executing without user interruption.

### http
Executes a standard HTTP request to fetch data from an API.

**`args` Properties:**
*   `url` *(string, required)*: The endpoint URL. Supports variable interpolation.
*   `method` *(string, default: "GET")*: The HTTP method (e.g., `GET`, `POST`).
*   `headers` *(object, optional)*: A dictionary of HTTP headers. This is commonly used to inject authorization tokens retrieved from previous steps (e.g., `{"Authorization": "Bearer {access_token}"}`).

**Outputs:**
The underlying engine returns three objects that you can map to your custom variables:
*   `http_response`: The automatically parsed JSON dictionary of the response body.
*   `raw_data`: The raw text string of the response.
*   `headers`: A dictionary of the response headers.

### extract
Extracts specific values from complex data structures (like API responses or web scraping results) into isolated variables.

**`args` Properties:**
*   `source` *(any, required)*: The target data structure to extract from (usually injected via interpolation, e.g., `{http_response}`).
*   `type` *(string, default: "jsonpath")*: The extraction method. Supports `"jsonpath"` (for nested JSON querying using JSONPath syntax) or `"key"` (for simple dictionary key lookups, e.g., for headers).
*   `expr` *(string, required)*: The expression used for extraction (e.g., `$.data.attributes.balance` or `ratelimit-remaining`).

**Outputs:**
Maps the extracted single value to your specified variable name.

### script
Allows executing custom Python code to perform complex data cleansing, calculations, or logic formatting.

**`args` Properties:**
*   `code` *(string, required)*: The Python code snippet to execute.

**Execution Environment & Outputs:**
The script runs in a safe local environment where all previously generated variables (`outputs` from prior steps and global `context`) are injected as local variables.
You can directly read or modify these variables inside the script. The engine will inspect the local environment after the script finishes and automatically capture any variable names you defined in the `outputs` mapping.

## Full Example

The following example demonstrates a complete flow for the "Soniox" integration. It uses the `webview` step to silently capture dashboard data in the background without requiring user interaction, then utilizes multiple `extract` steps to pull specific billing and usage metrics.

```yaml
integrations:
  - id: soniox_dashboard_webview
    name: "Soniox Dashboard (WebView)"
    description: "Silently fetches Soniox billing data via a background webview."

    flow:
      # Step 1: Background scraping
      - id: webview_fetch
        use: webview
        args:
          url: "https://console.soniox.com/"
          intercept_api: "/dashboard/"
        outputs:
          # Maps the intercepted API payload to a variable named 'dashboard_response'
          dashboard_response: "dashboard_response"

      # Step 2: Extract available balance
      - id: parse_billing
        use: extract
        args:
          source: "{dashboard_response}"
          type: "jsonpath"
          expr: "$.billing.available_balance_usd"
        outputs:
          # Exposes the value for the View Template
          available_balance: "available_balance"

      # Step 3: Extract current month usage
      - id: parse_usage
        use: extract
        args:
          source: "{dashboard_response}"
          type: "jsonpath"
          expr: "$.mtd_usage.total_paid_amount_usd"
        outputs:
          # Exposes the value for the View Template
          total_usage: "total_usage"

    # View templates can now utilize {available_balance} and {total_usage}
    # exactly as they were defined in the final flow outputs.
    templates:
      - label: "Soniox Quota"
        type: "source_card"
        ui:
          title: "Soniox"
          icon: "üéôÔ∏è"
        widgets:
          - type: "hero_metric"
            amount: "{available_balance}"
            currency: "USD"
```
